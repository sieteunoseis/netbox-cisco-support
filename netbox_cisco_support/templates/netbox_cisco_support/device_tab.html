{% extends 'dcim/device/base.html' %}
{% load helpers %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% if not show_tab %}
        <div class="alert alert-warning">
            <i class="mdi mdi-alert"></i> {{ error|default:"Device does not meet requirements for Cisco Support lookup (requires serial number and Cisco manufacturer)" }}
        </div>
        {% elif error %}
        <div class="alert alert-warning">
            <i class="mdi mdi-alert"></i> {{ error }}
        </div>
        {% elif product_data %}

        <!-- Product Information Card -->
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-tag"></i> Product Information
                    {% if product_data.cached %}
                    <span class="badge bg-secondary text-white ms-2"><i class="mdi mdi-cached"></i> Cached</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th style="width: 40%;">Serial Number:</th>
                                <td><code>{{ serial_number }}</code></td>
                            </tr>
                            <tr>
                                <th>Product ID (PID):</th>
                                <td><code>{{ product_data.base_pid|default:product_data.orderable_pid|default:"N/A" }}</code></td>
                            </tr>
                            <tr>
                                <th>Orderable PID:</th>
                                <td>{{ product_data.orderable_pid|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th>Product Name:</th>
                                <td>{{ product_data.product_name|default:"N/A" }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th style="width: 40%;">Product Series:</th>
                                <td>{{ product_data.product_series|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th>Product Category:</th>
                                <td>{{ product_data.product_category|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th>Product Type:</th>
                                <td>{{ product_data.product_type|default:"N/A" }}</td>
                            </tr>
                            <tr>
                                <th>Orderable Status:</th>
                                <td>
                                    {% if product_data.orderable_status == "O" %}
                                    <span class="badge bg-success text-white">Orderable</span>
                                    {% elif product_data.orderable_status == "N" %}
                                    <span class="badge bg-danger text-white">Not Orderable</span>
                                    {% else %}
                                    <span class="badge bg-secondary text-white">{{ product_data.orderable_status|default:"Unknown" }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if product_data.product_support_page %}
                <div class="mt-3">
                    <a href="{{ product_data.product_support_page }}" target="_blank" class="btn btn-outline-primary btn-sm">
                        <i class="mdi mdi-open-in-new"></i> View Product Support Page
                    </a>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- End-of-Life Status Card -->
        {% if eox_data %}
        <div class="card mb-3">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-calendar-clock"></i> End-of-Life Status
                    {% if eox_data.EOLProductID %}
                    <span class="badge bg-warning text-dark ms-2">EoX Announced</span>
                    {% endif %}
                    {% if eox_data.cached %}
                    <span class="badge bg-secondary text-white ms-2"><i class="mdi mdi-cached"></i> Cached</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th style="width: 50%;">Product ID:</th>
                                <td><code>{{ eox_data.EOLProductID|default:"N/A" }}</code></td>
                            </tr>
                            <tr>
                                <th>End of Sale Date:</th>
                                <td>
                                    {% if eox_data.EndOfSaleDate.value %}
                                    <span class="{% if eox_data.EndOfSaleDate.value < today %}text-danger fw-bold{% endif %}">
                                        {{ eox_data.EndOfSaleDate.value }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>End of SW Maintenance:</th>
                                <td>
                                    {% if eox_data.EndOfSWMaintenanceReleases.value %}
                                    <span class="{% if eox_data.EndOfSWMaintenanceReleases.value < today %}text-danger fw-bold{% endif %}">
                                        {{ eox_data.EndOfSWMaintenanceReleases.value }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>End of Security Support:</th>
                                <td>
                                    {% if eox_data.EndOfSecurityVulSupportDate.value %}
                                    <span class="{% if eox_data.EndOfSecurityVulSupportDate.value < today %}text-danger fw-bold{% endif %}">
                                        {{ eox_data.EndOfSecurityVulSupportDate.value }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless mb-0">
                            <tr>
                                <th style="width: 50%;">End of Routine Failure:</th>
                                <td>
                                    {% if eox_data.EndOfRoutineFailureAnalysisDate.value %}
                                    {{ eox_data.EndOfRoutineFailureAnalysisDate.value }}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>End of Service Renewal:</th>
                                <td>
                                    {% if eox_data.EndOfServiceContractRenewal.value %}
                                    {{ eox_data.EndOfServiceContractRenewal.value }}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Last Date of Support:</th>
                                <td>
                                    {% if eox_data.LastDateOfSupport.value %}
                                    <span class="{% if eox_data.LastDateOfSupport.value < today %}text-danger fw-bold{% endif %}">
                                        {{ eox_data.LastDateOfSupport.value }}
                                    </span>
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Migration Product:</th>
                                <td>
                                    {% if eox_data.EOXMigrationDetails.MigrationProductId %}
                                    <code>{{ eox_data.EOXMigrationDetails.MigrationProductId }}</code>
                                    {% if eox_data.EOXMigrationDetails.MigrationProductInfoURL %}
                                    <a href="{{ eox_data.EOXMigrationDetails.MigrationProductInfoURL }}" target="_blank" class="ms-1">
                                        <i class="mdi mdi-open-in-new"></i>
                                    </a>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                {% if eox_data.LinkToProductBulletinURL %}
                <div class="mt-3">
                    <a href="{{ eox_data.LinkToProductBulletinURL }}" target="_blank" class="btn btn-outline-warning btn-sm">
                        <i class="mdi mdi-open-in-new"></i> View EoX Bulletin
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Security Advisories Card -->
        {% if psirt_data %}
        <div class="card mb-3">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#psirt-section" style="cursor: pointer;">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-shield-alert"></i> Security Advisories (PSIRT)
                    {% if psirt_data.total > 0 %}
                    <span class="badge bg-danger text-white ms-2">{{ psirt_data.total }} Advisory{{ psirt_data.total|pluralize:",ies" }}</span>
                    {% else %}
                    <span class="badge bg-success text-white ms-2">No Advisories</span>
                    {% endif %}
                    {% if psirt_data.cached %}
                    <span class="badge bg-secondary text-white ms-2"><i class="mdi mdi-cached"></i> Cached</span>
                    {% endif %}
                    <i class="mdi mdi-chevron-down float-end"></i>
                </h5>
            </div>
            <div id="psirt-section" class="collapse {% if psirt_data.total > 0 %}show{% endif %}">
                <div class="card-body">
                    {% if psirt_data.advisories %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Advisory ID</th>
                                    <th>Title</th>
                                    <th>Severity</th>
                                    <th>CVE</th>
                                    <th>Published</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for advisory in psirt_data.advisories %}
                                <tr>
                                    <td>
                                        <a href="https://sec.cloudapps.cisco.com/security/center/content/CiscoSecurityAdvisory/{{ advisory.advisoryId }}" target="_blank" class="text-decoration-none">
                                            <i class="mdi mdi-open-in-new"></i> {{ advisory.advisoryId }}
                                        </a>
                                    </td>
                                    <td>{{ advisory.advisoryTitle|truncatechars:60 }}</td>
                                    <td>
                                        {% if advisory.sir == "Critical" %}
                                        <span class="badge bg-danger text-white">Critical</span>
                                        {% elif advisory.sir == "High" %}
                                        <span class="badge bg-warning text-dark">High</span>
                                        {% elif advisory.sir == "Medium" %}
                                        <span class="badge bg-info text-dark">Medium</span>
                                        {% else %}
                                        <span class="badge bg-secondary text-white">{{ advisory.sir|default:"N/A" }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if advisory.cves %}
                                        {{ advisory.cves|join:", "|truncatechars:30 }}
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ advisory.firstPublished|default:"N/A" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if psirt_data.total > 10 %}
                    <div class="mt-2 text-muted small">
                        Showing 10 of {{ psirt_data.total }} advisories
                    </div>
                    {% endif %}
                    {% else %}
                    <div class="text-success">
                        <i class="mdi mdi-check-circle"></i> No security advisories found for this product
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Bugs Card -->
        {% if bugs_data %}
        <div class="card mb-3">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#bugs-section" style="cursor: pointer;">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-bug"></i> Known Bugs (Severity 1-3)
                    {% if bugs_data.bugs %}
                    <span class="badge bg-warning text-dark ms-2">{{ bugs_data.bugs|length }} Bug{{ bugs_data.bugs|length|pluralize }}</span>
                    {% else %}
                    <span class="badge bg-success text-white ms-2">No Critical Bugs</span>
                    {% endif %}
                    {% if bugs_data.cached %}
                    <span class="badge bg-secondary text-white ms-2"><i class="mdi mdi-cached"></i> Cached</span>
                    {% endif %}
                    <i class="mdi mdi-chevron-down float-end"></i>
                </h5>
            </div>
            <div id="bugs-section" class="collapse">
                <div class="card-body">
                    {% if bugs_data.bugs %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead>
                                <tr>
                                    <th>Bug ID</th>
                                    <th>Headline</th>
                                    <th>Severity</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for bug in bugs_data.bugs %}
                                <tr>
                                    <td>
                                        <a href="https://bst.cloudapps.cisco.com/bugsearch/bug/{{ bug.bug_id }}" target="_blank" class="text-decoration-none">
                                            <i class="mdi mdi-open-in-new"></i> {{ bug.bug_id }}
                                        </a>
                                    </td>
                                    <td>{{ bug.headline|truncatechars:60 }}</td>
                                    <td>
                                        {% if bug.severity == "1" %}
                                        <span class="badge bg-danger text-white">Sev 1 - Catastrophic</span>
                                        {% elif bug.severity == "2" %}
                                        <span class="badge bg-danger text-white">Sev 2 - Severe</span>
                                        {% elif bug.severity == "3" %}
                                        <span class="badge bg-warning text-dark">Sev 3 - Moderate</span>
                                        {% elif bug.severity == "4" %}
                                        <span class="badge bg-info text-dark">Sev 4 - Minor</span>
                                        {% elif bug.severity == "5" %}
                                        <span class="badge bg-secondary text-white">Sev 5 - Cosmetic</span>
                                        {% elif bug.severity == "6" %}
                                        <span class="badge bg-secondary text-white">Sev 6 - Enhancement</span>
                                        {% else %}
                                        <span class="badge bg-secondary text-white">{{ bug.severity|default:"N/A" }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if bug.status == "O" %}
                                        <span class="badge bg-danger text-white">Open</span>
                                        {% elif bug.status == "F" %}
                                        <span class="badge bg-success text-white">Fixed</span>
                                        {% elif bug.status == "T" %}
                                        <span class="badge bg-secondary text-white">Terminated</span>
                                        {% else %}
                                        <span class="badge bg-secondary text-white">{{ bug.status|default:"N/A" }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-success">
                        <i class="mdi mdi-check-circle"></i> No critical bugs (severity 1-3) found for this product
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Software Suggestions Card -->
        {% if software_data and software_data.productList %}
        <div class="card mb-3">
            <div class="card-header" data-bs-toggle="collapse" data-bs-target="#software-section" style="cursor: pointer;">
                <h5 class="card-title mb-0">
                    <i class="mdi mdi-download"></i> Software Recommendations
                    {% if software_data.cached %}
                    <span class="badge bg-secondary text-white ms-2"><i class="mdi mdi-cached"></i> Cached</span>
                    {% endif %}
                    <i class="mdi mdi-chevron-down float-end"></i>
                </h5>
            </div>
            <div id="software-section" class="collapse">
                <div class="card-body">
                    {% for product in software_data.productList %}
                    {% if product.suggestions %}
                    <h6 class="mb-2">{{ product.product|default:product_id }}</h6>
                    <table class="table table-sm table-borderless mb-3">
                        {% for suggestion in product.suggestions %}
                        <tr>
                            <th style="width: 30%;">Suggested Release:</th>
                            <td>
                                <code>{{ suggestion.releaseTrain|default:suggestion.releaseFormat }}</code>
                                {% if suggestion.isSuggested %}
                                <span class="badge bg-success text-white ms-2">Recommended</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% if suggestion.releaseDate %}
                        <tr>
                            <th>Release Date:</th>
                            <td>{{ suggestion.releaseDate }}</td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </table>
                    {% endif %}
                    {% empty %}
                    <div class="text-muted">
                        <i class="mdi mdi-information"></i> No software suggestions available for this product
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- External Links -->
        <div class="mt-3">
            {% if product_id %}
            <a href="https://www.cisco.com/c/en/us/support/all-products.html?search={{ product_id }}" target="_blank" class="btn btn-primary btn-sm me-2">
                <i class="mdi mdi-open-in-new"></i> Search Cisco Support
            </a>
            <a href="https://bst.cloudapps.cisco.com/bugsearch/search?kw={{ product_id }}" target="_blank" class="btn btn-outline-warning btn-sm me-2">
                <i class="mdi mdi-bug"></i> Search All Bugs
            </a>
            {% endif %}
            {% if serial_number %}
            <a href="https://www.cisco.com/cgi-bin/Support/Dnld/dnld.pl?sos={{ serial_number }}" target="_blank" class="btn btn-outline-info btn-sm">
                <i class="mdi mdi-download"></i> Download Software
            </a>
            {% endif %}
        </div>

        {% else %}
        <div class="alert alert-info">
            <i class="mdi mdi-information"></i> No product data available from Cisco Support API for serial number <code>{{ serial_number }}</code>.
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
